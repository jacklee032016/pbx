# $Id: README,v 1.6 2007/03/14 18:57:47 lizhijie Exp $

                   README for cgipbx Program
                             Li Zhijie  2007.03.09

存在问题
    写入账号的权限时，只能写入账号的关闭命令(6:CANCEL)
    写入账号的口令后，没有账号口令的返回命令

    返回外线组的命令，并没有被PBX执行
    
    分机的DifferRing|Group最好分为两个命令
    resetPBX后，外线console的命令没有返回最后一条外线的状态

    reset操作将PBX的配置设置为17909等默认配置，而不是重新启动PBX


呼叫转移的操作
    从PBX读出的呼叫转移信息是分机的索引：
        其中号码是以一个字节编码为两位号码形式
            忙转移分机、秘书分机则是一个字节一位号码的形式
    网页中填写的呼叫转移信息是分机的电话号码
        写号码到PBX时，
            秘书分机、帮转移分机比较简单，字节将号码转换为索引写出即可
            无条件、离位转移、夜服三种在取得分机索引后，需要：
                如果号码只有一位，则字节输出
                否则，需要将号码两位合并为一位后，输出
                
    保存到配置文件的是转移的分机号码
    
    两者需要在后台程序中变换
    
    以上变换只发生在号码位数小于4时，这种形式下，认为配置的号码是本地分机号码。
    如果配置的号码多余4位，则可以认为呼叫转移发生在外面的PSTN号码和IP电话号码，
    最多可以配置的号码是18位


程序的目的
    从uartd程序读取状态并写入配置文件：黑名单和pbx设备两个配置文件
    从cgi读取配置命令，写配置文件，并配置到pbx设备上


CGI程序的流程
   注册到后台程序的信号处理函数
   如果是配置操作，则写配置信息到tmp配置文件 
   通知后台程序
      如果是启动操作，则通知后台程序读取PBX的状态
      如果是配置操作，则通知后台程序自行配置操作
   
   延迟一秒，以读取后台程序返回的信息
   如果是配置操作，则通知后台写OK，并启动自动的延迟刷新，并进入读流程
    
   以下流程只在读操作
       读取后台程序写入的配置文件
       显示当前的配置信息和配置页面

   CGI程序的配置内容
       基本配置
       分机基本配置
       分机特殊配置
       外线配置
       中继配置
       账号配置
       特服配置
       计费配置
       会议配置


后台程序的流程
    启动流程
        注册消息处理函数
        创建从uratd读取数据的线程
        启动从PBX上读取数据的操作

    从CGI到PBX的流程
        读取网管程序写入的暂存文件
        比较暂存文件的内容，并更新配置文件的内容
        将暂存文件的内容配置到PBX中
        
        

以下是原来配置方案下的配置文件内容

# cat /etc/pbx/pbx.conf 
cc01    1	trunck

pc01    0	differ ring
pc02    0	call id mode: dtmf 
pc03    0	no dial actino
pc04    1	line 2 line
pc06    8	PSTN prefix
pc08    0	special first
pc09    0	group call
pc10    17909	ip prefix

pc05	passwd not provide
pc07	system passwd not provide

lc010   1
lc011   1
lc012   1
lc013   1
lc020   0
lc021   0
lc022   0
lc023   0
ac030   6
ac031   6
bc030   2
bc031   2
bc032   2
bc033   2
bc034   2
bc035   2
bc036   2
bc037   2
bc080   1
bc081   1
bc082   1
bc083   1
bc084   1
bc085   1
bc086   1
bc087   1
bc040   0
bc041   0
bc042   0
bc043   0
bc044   0
bc045   0
bc046   0
bc047   0
sc020   110
sc021   119
sc022   120

分机号码
bc010   1
bc011   2
bc012   3
bc013   4
bc014   5
bc015   6
bc016   7
bc017   8

bc020   0
bc021   0
bc022   0
bc023   0
bc024   0
bc025   0
bc026   0
bc027   0
bc090   0
bc091   0
bc092   0
bc093   0
bc094   0
bc095   0
bc096   0
bc097   0
bc260   0
bc261   0
bc262   0
bc263   0
bc264   0
bc265   0
bc266   0
bc267   0
bc220   0
bc221   0
bc222   0
bc223   0
bc224   0
bc225   0
bc226   0
bc227   0
bcs150  10
bcs151  10
bcs152  10
bcs153  10
bcs154  10
bcs155  10
bcs156  10
bcs157  10
bcs250  1
bcs170  0
bcs251  1
bcs171  0
bcs252  1
bcs172  0
bcs253  1
bcs173  0
bcs254  0
bcs174  0
bcs255  0
bcs175  0
bcs256  0
bcs176  0
bcs257  0
bcs177  0

       