
;                   STC ISP DEMO 程序通讯协议

;STC89LE51RC, STC89LE52RC, STC89LE53RC, STC89LE54RD+, STC89LE58RD+, STC89LE516RD+
;STC89C51RC, STC89C52RC, STC89C53RC, STC89C54RD+, STC89C58RD+, STC89C516RD+
;
;1. 功能
;        STC ISP DEMO 程序以固定的波特率与上位机(PC机)通讯，将上位机
;    传来的程序代码或数据烧录到 MCU 的用户应用程序区中(以下简称 AP 区)和
;    Data 区。
;
;1.1 应用范围
;    本协议仅适用于 STC89C/LE5xRC 和 STC89C/LE5xxRD+ 系列单片机。
;1.2 使用方法
;   1) 将 STC ISP DEMO 程序烧录到 MCU 的 ISP 区, 并设置为上电复位后从
;      ISP 区开始运行。
;   2) 先运行上位机程序，不断地发送问讯帧，然后给 MCU 上电。
;   3) MCU 收到问讯帧后回发问讯应答帧，讯问应答反复 3 次双方连接成功。
;   4) 上位机发送一系列命令，完成下载工作。
;   5) 下载完毕，PC 发送切换命令，MCU 软复位切换到 AP 程序运行。
;
;       STC-ISP (2.8 Beta3 版本以上)下载软件提供了STC ISP DEMO 程序的上位机
;   功能，该软件可到 MCU-Memory.COM 网站下载。
;       MCU 上电复位后检测串口是否有上位机发来的问讯帧, 若没有就立刻软复位
;   切换到 AP 程序运行。也可以参照 STC 下载软件中"用户自定义下载" 功能, 
;   从应用程序软复位切换到 ISP 进行下载，而不是每次都要上电复位(冷启动)
;   进入 ISP 程序。
;
;2.  帧格式。
;    所有的通讯均由 PC 机启动。
;
;2.1 PC机命令帧格式。
;        5AH               0101,1010 起始字节1 ----        ------
;        A5H               1010,0101 起始字节2     |             |
;        len_H             帧长度高字节            |             |
;        len_L             帧长度低字节                          |
;        Command           命令字             帧校验和范围       |
;        data 0            数据区第 1 字节                       
;         ..                                       |        帧长度范围
;         ..                                       |             
;         ..                                       |             |
;        data n-1          数据区第 n 字节     ----              |
;        check_sum_high    帧校验和高字节                        |
;        chenk_sum_low     帧校验和低字节                        |
;        16H               结束字节  ----------------------------
;
;2.2 MCU 应答帧格式。
;        5AH               0101,1010 起始字节1 ----        ------ 
;        A5H               1010,0101 起始字节2     |             |
;        len_H             帧长度高字节            |             |
;        len_L             帧长度低字节                          |
;        code              命令字             帧校验和范围       |
;        data 0            数据区第 1 字节                       
;         ..                                       |        帧长度范围
;         ..                                       |             
;         ..                                       |             |
;        data n-1          数据区第 n 字节     ----              |
;        check_sum_high    帧校验和高字节                        |
;        check_sum_low     帧校验和低字节                        |
;        16H               结束字节  ----------------------------
;
;2.3 帧长度。
;    帧长度范围从起始字节1 至结束字节。
;
;2.4 校验和。
;    从起始字节1开始到校验和之前所有的字节相加。
;
;3.0 PC 命令及 MCU 应答
;    命令                     命令代码 
;
;    问讯                       B0H     1011, 0000 
;    软复位切换到用户程序       B1H     1011, 0001 
;    擦除 AP、Data flash        B2H     1011, 0010 
;    写数据到 AP、Data flash    B3H     1011, 0011 
;    先擦除扇区再写数据         B4H     1011, 0100 
;    读固件版本号               B5H     1011, 0101 
;
;3.1 问讯帧。
;
;3.1.1 PC 发送问讯帧。
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   08H             帧长度低字节
;      4   B0H             问讯帧命令字
;      5   01H             校验和高字节 (5AH + A5H + 00H + 08H + B0H = 01B7H)
;      6   B7H             校验和低字节
;      7   16H             结束字节
;
;3.1.2 MCU 回发问讯应答帧。
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   08H             帧长度低字节
;      4   B0H             问讯应答帧命令字
;      5   01H             校验和高字节 (5AH + A5H + 00H + 08H + B0H = 01B7H)
;      6   B7H             校验和低字节
;      7   16H             结束字节
;
;3.2 结束运行 ISP 程序, 软复位切换到用户程序。
;     ISP 程序收到命令后启动软复位，切换到用户程序运行。
;3.2.1 PC 命令
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   08H             帧长度低字节
;      4   B1H             软复位切换到用户程序命令字
;      5   01H             校验和高字节 (5AH + A5H + 00H + 08H + B1H = 01B8H)
;      6   B8H             校验和低字节
;      7   16H             结束字节
;
;3.2.2 MCU 应答：
;    用"问讯应答帧"应答, 见 3.1.2 MCU 问讯应答帧。
;
;3.3 擦除应用程序区和数据 Flash 区
;3.3.1 PC 命令：
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   08H             帧长度低字节
;      4   B2H             擦除应用程序区命令字
;      5   01H             校验和高字节 (5AH + A5H + 00H + 08H + B2H = 01B9H)
;      6   B9H             校验和低字节
;      7   16H             结束字节
;
;3.3.2 MCU 应答：
;    用"问讯应答帧"应答, 见 3.1.2 MCU 问讯应答帧。
;
;3.4 写数据到 flash AP 区
;3.4.1 PC 命令：
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   xxH             帧长度低字节
;      4   B3H             写数据到 flash 命令字
;      5   00H             保留字节
;      6   00H             保留字节
;      7   address_H       目标首地址高字节
;      8   address_L       目标首地址低字节
;      9   00H             数据块长度高字节。
;     10   xxH             数据块长度低字节
;                          每次最多写 128 字节。写完一个 512 字节的扇区需分别
;                          发送 4 帧数据。某个扇区一旦写失败，须擦除该扇区后
;                          从头再写。
;     11   data 1          数据块第 1 字节
;
;     ..    ..      
;      
;     xx   data n          数据块第 n 字节
;     xx   xxH             校验和高字节
;     xx   xxH             校验和低字节
;     xx   16H             结束字
;     
;3.4.2 MCU 应答：
;    序号  内容
;      0   5AH             起始字节1
;      1   A5H             起始字节2
;      2   00H             帧长度高字节
;      3   0AH             帧长度低字节
;      4   B3H             写数据到 flash 命令字
;      5   xxH             数据区校验和高字节，见 3.4.3 写数据到 flash AP 区后的校验
;      6   xxH             数据区校验和低字节，见 3.4.3 写数据到 flash AP 区后的校验
;      7   xxH             帧校验和高字节
;      8   xxH             帧校验和低字节
;      9   16H             结束字节
;
;3.4.3 写数据到 flash AP 区后的校验：
;        MCU 把本次接收到的应用程序和数据写入 Flash 后再将它们逐一读出来，计算它们的
;    累加和。累加和的校验区由 2.4.1 的目标首地址和数据块长度指明(PC 命令的7,8,9,10字节)
;    累加和为 2 个字节，发回 PC 供其判断写数据正确与否。

;3.5 擦除扇区后再写数据到 flash AP 区
;    除了命令字为 B4H 外，其它与写数据到 flash AP 区完全一致。
;
;3.6 读 MCU 代号、固件版本号命令。
;3.6.1 PC 命令：
;    序号  内容
;      0   5AH              起始字节1
;      1   A5H              起始字节2
;      2   00H              帧长度高字节
;      3   08H              帧长度低字节
;      4   B5H              读 MCU 代号、固件版本号命令字
;      5   01H              帧校验和高字节
;      6   F9H              帧校验和低字节
;      7   16H              结束字节
;
;3.6.2 MCU 应答：
;    序号  内容
;      0   5AH              起始字节1
;      1   A5H              起始字节2
;      2   00H              帧长度高字节
;      3   0CH              帧长度低字节
;      4   B5H              读 MCU 代号、固件版本号命令字
;      5   FIRMWARE_VERSION 固件版本号
;      6   MCU_TYPE_HIGH    MCU 代号高字节
;      7   MCU_TYPE_LOW     MCU 代号低字节
;      8   xxH              保留字节
;      9   xxH              帧校验和高字节
;     10   xxH              帧校验和低字节
;     11   16H              结束字节


;计算重载数:
;----------------------------------------------------------------------
;晶体频率: Fosc
;波特率:   Baud
;重载数:   RELOAD = INT(Fosc/Baud/32 + 0.5), INT 表示取整运算(舍去小数) 
;将重载数转换成 16 进制, 用 10000H 减重载数, 存入 RCAP2H, RCAP2L
;计算实际的波特率: Baud = Fosc/RELOAD/32, 如果误差>3.5要更改波特率.

;例: Fosc = 22.1184MHz, Baud = 115200
;  RELOAD = INT( 22118400/115200/32 + 0.5)
;         = INT( 6.5 )
;         = 6
;         = 0006H
; 10000H - 0006H = FFFAH
;
;   MOV   RCAP2H, #0FFH
;   MOV   RCAP2L, #0FAH


;例: Fosc = 20.MHz, Baud = 57600 (Baud=115200时误差太大) 
;  RELOAD = INT( 20000000/57600/32 + 0.5)
;         = INT( 10.85 + 0.5 )
;         = INT( 11.35 )
;         = 11
;         = 000BH
; 10000H - 000BH = FFF5H
;
;   MOV   RCAP2H, #0FFH
;   MOV   RCAP2L, #0F5H


烧写ISP程序
    编译汇编代码为HEX格式
    在烧写程序中
        选择要烧写的HEX文件
        选择烧写ISP：即选择ISP空间为4.0K
        选择默认上电复位启动ISP的选项（默认选择的是启动IAP）
        ISP烧写的地址为0XEC00（默认选择的是IAP烧写的地址0X0000）
           写入的必须是小写的ec00，不能带0X等
           正确设置后，载入hex文件时会有警告，这时烧录就可以成功
        
    启动烧写操作
    为烧写板子上电
        默认自动的烧写中，会清除全部的FLASH内容，包括IAP和数据区
        因此需要重新写IAP
        所以ISP烧写板默认用于烧写ISP程序，而不烧写IAP     

通过ISP烧写IAP的方法
    串口的IXP4XX程序isp来烧写IAP程序
    IAP要首先编译为HEX格式文件
    再转换为binary文件
    实际要使用binary程序来烧写
